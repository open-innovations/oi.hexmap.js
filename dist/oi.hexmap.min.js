/**
	OI hex map in SVG
	0.8.2:
	    - Minor bug fix for boundary lines
	0.8.1:
	    - Can set the label and tooltip keys using updateLabels(labelkey,tooltipkey)
	0.8.0:
	    - Update DOM
	0.7.0:
	    - Draw boundary lines
		- Add patterns
	0.6.4:
		- Remove browser tooltip
	0.6.3:
		- fitToRange()
	0.6.2:
		- allow multiple callbacks to be added with .on()
	0.6.1:
		- bug fixes
	0.6.0:
		- change namespace
		- set padding
		- can provide function to updateColours()
 */
!function(t){var e=t.OI||{};function i(t,e){return"number"==typeof t&&(t=t.toFixed(e)),t.replace(/\.([0-9]+)0+$/,function(t,e){return"."+e}).replace(/\.0+$/,"")}e.ready||(e.ready=function(t){"loading"!=document.readyState?t():document.addEventListener("DOMContentLoaded",t)}),e.ajax||(e.ajax=function(t,e){e||(e={});var i=new XMLHttpRequest;return"responseType"in i&&e.dataType&&(i.responseType=e.dataType),i.open(e.method||"GET",t+(e.cache?"?"+Math.random():""),!0),i.onload=function(i){if(this.status>=200&&this.status<400){var s=this.response;"function"==typeof e.success&&e.success.call(e.this||this,s,{url:t,data:e,originalEvent:i})}else"function"==typeof e.error&&e.error.call(e.this||this,i,{url:t,data:e})},"function"==typeof e.error&&(i.onerror=function(i){e.error.call(e.this||this,i,{url:t,data:e})}),i.send(),this}),e.hexmap=function(t,l){this.version="0.8.2",l||(l={}),this._attr=l,this.title="OI HexMap",this.logging=location.search.indexOf("debug=true")>=0;var p=new function(t){return t||(t={}),t.title||(t.title="Log"),t.version||(t.version="2.0"),this.message=function(...e){var i=e.shift();"string"!=typeof i&&(i="log");var s=["%c"+t.title+" "+t.version+"%c"];e.length>0&&(s[0]+=":","string"==typeof e[0]&&(s[0]+=" "+e.shift())),s.push("font-weight:bold;"),s.push(""),e.length>0&&(s=s.concat(e)),console[i].apply(null,s)},this}({title:"OI HexMap",version:this.version});if(this.log=p.message,!t)return this.log("warn","No DOM element to add to"),this;l.label||(l.label={}),l.tooltip||(l.tooltip={}),l.grid||(l.grid={}),"boolean"!=typeof l.label.show&&(l.label.show=!1),"boolean"!=typeof l.label.clip&&(l.label.clip=!1),"boolean"!=typeof l.grid.show&&(l.grid.show=!1);var d=l.width||t.offsetWidth||300,c=l.height||t.offsetHeight||150;this.maxw=d,this.maxh=c;var u,f,m,g,y,x=d/c,v=!1,b={},q=parseFloat(getComputedStyle(t)["font-size"])||16;this.areas={},this.padding="number"==typeof l.padding?l.padding:0,this.properties={size:l.size},this.callback={},this.mapping={};var w=this;if(t.classList.add("oi-viz","oi-map","oi-map-hex"),!t.querySelector(".hexmap-inner")){var k=document.createElement("div");k.classList.add("oi-top"),k.innerHTML='<div class="oi-left"></div><div class="oi-right"></div>',t.appendChild(k);var z=document.createElement("div");z.classList.add("oi-map-holder"),t.appendChild(z);var S=document.createElement("div");S.classList.add("oi-bottom"),S.innerHTML='<div class="oi-left"></div><div class="oi-right"></div>',t.appendChild(S),this.el=document.createElement("div"),this.el.classList.add("oi-map-inner"),this.el.style.position="relative",z.appendChild(this.el)}for(var L in this.options={clip:l.label.clip,showgrid:l.grid.show,showlabel:l.label.show,formatLabel:"function"==typeof l.label.format?l.label.format:function(t,e){return t.substr(0,3)},formatTooltip:"function"==typeof l.tooltip.format?l.tooltip.format:function(t,e){return t},minFontSize:"number"==typeof l.minFontSize?l.minFontSize:4},this.style={default:{fill:"#cccccc","fill-opacity":1,"font-size":q,"stroke-width":1.5,"stroke-opacity":1,stroke:"#ffffff"},highlight:{fill:"#1DD3A7"},grid:{fill:"#aaa","fill-opacity":.1}},l.style)l.style[L]&&(this.style[L]||(this.style[L]={}),"string"==typeof l.style[L].fill&&(this.style[L].fill=l.style[L].fill),"number"==typeof l.style[L]["fill-opacity"]&&(this.style[L]["fill-opacity"]=l.style[L]["fill-opacity"]),"string"==typeof l.style[L]["font-size"]&&(this.style[L]["font-size"]=l.style[L]["font-size"]),"string"==typeof l.style[L].stroke&&(this.style[L].stroke=l.style[L].stroke),"number"==typeof l.style[L]["stroke-width"]&&(this.style[L]["stroke-width"]=l.style[L]["stroke-width"]),"number"==typeof l.style[L]["stroke-opacity"]&&(this.style[L]["stroke-opacity"]=l.style[L]["stroke-opacity"]));function H(t,e,i){return"odd-r"==i&&0!=(1&e)&&(t+=.5),"even-r"==i&&0==(1&e)&&(t+=.5),"odd-q"==i&&0!=(1&t)&&(e+=.5),"even-q"==i&&0==(1&t)&&(e+=.5),{q:t,r:e}}function M(t,e){var i=[];if(t.data.hexmap.callback[e])for(var s=0;s<t.data.hexmap.callback[e].length;s++){for(var a in t.data.hexmap.callback[e][s].attr)t.data.hexmap.callback[e][s].attr[a]&&(t.data[a]=t.data.hexmap.callback[e][s].attr[a]);"function"==typeof t.data.hexmap.callback[e][s].fn&&i.push(t.data.hexmap.callback[e][s].fn.call(t.data.this||this,t))}return i||!1}return this.setHexSize=function(t){return"number"!=typeof t&&(t=10),t=Math.round(100*t)/100,l.size=t,this.properties.size=t,this},this.load=function(t,i,s){function a(t,e){w.setMapping(t),e&&w.updateColours(),"function"==typeof s&&s.call(w,{data:i})}return"function"!=typeof i||s||(s=i,i=""),"string"==typeof t?e.ajax(t,{this:this,dataType:"json",success:function(t){a(t)},error:function(e,i){this.log("error","Unable to load "+t,i)}}):"object"==typeof t&&setTimeout(function(){a(t,!0)},100),this},this.addHexes=function(t,e,i){if(this.mapping.layout)if(t.layout==this.mapping.layout){for(var s in t.hexes)this.mapping.hexes[s]=t.hexes[s];t=this.mapping}else this.log("warn","Layout has changed so over-writing existing hexes.");this.load(t,e,i)},window.addEventListener("resize",function(t){w.size()}),this.setHexStyle=function(t){var e,i,s;if(e=this.areas[t],i=r(this.style.default),e.active&&(i.fill=e.fillcolour),e.hover&&e.hex.classList.add("hover"),e.selected)for(s in this.style.selected)this.style.selected[s]&&(i[s]=this.style.selected[s]);return this.mapping.hexes[t].class&&this.mapping.hexes[t].class,n(e.path,i),e},this.toFront=function(t){var e=this.areas[t].hex.cloneNode(!0);return e.querySelector("text")&&e.querySelector("text").remove(),e.querySelector("title")&&e.querySelector("title").remove(),e.querySelector("path").setAttribute("fill","none"),e.querySelector("path").setAttribute("vector-effect","non-scaling-stroke"),e.removeAttribute("id"),e.classList.add("outline"),g.innerHTML="",g.appendChild(e),this},this.regionToggleSelected=function(t,e){var i,s;if(this.selected=this.selected==t?"":t,(s=this.areas[t]).selected=!s.selected,this.setHexStyle(t),!s.selected&&e)for(i in this.areas)this.areas[i].selected&&(this.areas[i].selected=!1,this.setHexStyle(i));return this},this.regionFocus=function(t){return this.areas[t].hover=!0,this.el.querySelectorAll(".hover").forEach(function(t){t.classList.remove("hover")}),this.setHexStyle(t),this.toFront(t),this},this.regionBlur=function(t){return this.areas[t].hover=!1,this.setHexStyle(t),this},this.regionActivate=function(t){this.areas[t].active=!0,this.setHexStyle(t)},this.regionDeactivate=function(t){this.areas[t].active=!1,this.setHexStyle(t)},this.regionToggleActive=function(t){this.areas[t].active=!this.areas[t].active,this.setHexStyle(t)},this.selectRegion=function(t){for(var e in this.selected=t,this.areas)this.areas[e]&&(t.length>0&&0==e.indexOf(t)?(this.areas[e].selected=!0,this.setHexStyle(e)):(this.areas[e].selected=!1,this.setHexStyle(e)));return this},this.setClass=function(t){if("function"==typeof t)for(var e in this.areas)t.call(this,e,this.areas[e]);return this},this.on=function(t,e,i){return"function"!=typeof e||i||(i=e,e=""),"function"!=typeof i?this:(this.callback||(this.callback={}),this.callback[t]||(this.callback[t]=[]),this.callback[t].push({fn:i,attr:e}),this)},this.size=function(e,i){this.el.style.height="",this.el.style.width="",n(t,{style:""}),e=Math.min(this.maxw,t.offsetWidth),this.el.style.height=e/x+"px",this.el.style.width=e+"px",i=Math.min(this.maxh,this.el.offsetHeight),u||(n(u=o("svg"),{class:"oi-map-map",xmlns:s,version:"1.1",overflow:"visible",viewBox:l.viewBox||"0 0 "+e+" "+i,style:"max-width:100%;",preserveAspectRatio:"xMidYMin meet","vector-effect":"non-scaling-stroke"}),a(u,this.el),(y=o("g")).classList.add("data-layer"),y.setAttribute("role","table"),(f=o("g")).classList.add("series"),f.setAttribute("role","row"),(g=o("g")).classList.add("overlay")),n(u,{style:"width:"+e+"px;max-width: 100%; max-height: 100%; margin: auto; background: none;"});var r=e/d;return this.properties.size=l.size*r,d=e,c=i,this.el.style.height="",this.el.style.width="",this},this.initialized=function(){this.create().draw();var e=t.querySelector(".spinner");return e&&e.parentNode.removeChild(e),this},this.create=function(){return u.innerHTML="",this.areas={},this.grid&&this.grid.remove(),delete this.grid,v=!1,this},this.setMapping=function(t){this.mapping=t,this.properties||(this.properties={x:100,y:100});var e=t.layout.split("-");return this.properties.shift=e[0],this.properties.orientation=e[1],this.updateRange(),this.initialized()},this.updateRange=function(){var t,e,i,s;for(t in Math.sqrt(3),b={r:{min:1/0,max:-1/0},q:{min:1/0,max:-1/0}},this.mapping.hexes)this.mapping.hexes[t]&&(i=(e=this.mapping.hexes[t]).q,s=e.r,i>b.q.max&&(b.q.max=i),i<b.q.min&&(b.q.min=i),s>b.r.max&&(b.r.max=s),s<b.r.min&&(b.r.min=s));return b.q.d=b.q.max-b.q.min,b.r.d=b.r.max-b.r.min,b.q.mid=b.q.min+b.q.d/2,b.r.mid=b.r.min+b.r.d/2,"r"==this.properties.orientation&&(b.q.mid+=.25),"q"==this.properties.orientation&&(b.r.mid+=.25),b.q.min-=this.padding,b.q.max+=this.padding,b.r.min-=this.padding,b.r.max+=this.padding,this.range=r(b),"number"!=typeof l.size&&this.setHexSize(this.estimateSize()),this.setSize(),this},this.fitToRange=function(){return this.updateRange(),this.setHexSize(this.estimateSize()),this.setSize(),this},this.estimateSize=function(){var t,e,i,s;return"r"==this.properties.orientation?(0==b.r.d?(t=b.q.d+1,e=1):b.r.d>0&&(t=b.q.d+1.5,e=b.r.d+1),i=1.5*e+.5,s=2*t,Math.min(2/Math.sqrt(3)*d/s,c/i)):(0==b.q.d?(t=1,e=b.r.d+1):b.q.d>0&&(t=b.q.d+1,e=b.r.d+1.5),s=1.5*t+.5,i=2*e,Math.min(d/s,2/Math.sqrt(3)*c/i))},this.setSize=function(t){return t&&(this.properties.size=t),this.properties.s={cos:Math.round(10*this.properties.size*Math.sqrt(3)/2)/10,sin:.5*this.properties.size},this.properties.s.c=this.properties.s.cos.toFixed(2),this.properties.s.s=this.properties.s.sin.toFixed(2),this},this.getEdge=function(t){var e,s,a,r,n,o,h;return this.properties&&(a=this.properties.s.cos,r=this.properties.s.sin,h=Math.abs(t.e),o=t.e>=0,"number"==typeof t.q&&"number"==typeof t.r&&"number"==typeof h&&h>=1&&h<=6)?(n=H(t.q,t.r,this.mapping.layout),"r"==this.properties.orientation?(e=d/2+(n.q-this.range.q.mid)*a*2,s=c/2-(n.r-this.range.r.mid)*r*3):(e=d/2+(n.q-this.range.q.mid)*r*3,s=c/2-(n.r-this.range.r.mid)*a*2),(h=("r"==this.properties.orientation?[[e,s-2*r,a,r],[e+a,s-r,0,2*r],[e+a,s+r,-a,r],[e,s+2*r,-a,-r],[e-a,s+r,0,-2*r],[e-a,s-r,a,-r]]:[[e-r,s-a,2*r,0],[e+r,s-a,r,a],[e+2*r,s,-r,a],[e+r,s+a,-2*r,0],[e-r,s+a,-r,-a],[e-2*r,s,r,-a]])[h-1])[4]=h[0]+h[2],h[5]=h[1]+h[3],o||(h=[h[4],h[5],-h[2],-h[3],h[0],h[1]]),h[0]=i(h[0],3),h[1]=i(h[1],3),h[4]=i(h[4],3),h[5]=i(h[5],3),h):null},this.drawHex=function(t,e){var s,a,r,n,o,h;return this.properties?(r=this.properties.s.cos,n=this.properties.s.sin,h=H(t,e,this.mapping.layout),"r"==this.properties.orientation?(s=d/2+(h.q-this.range.q.mid)*r*2,a=c/2-(h.r-this.range.r.mid)*n*3):(s=d/2+(h.q-this.range.q.mid)*n*3,a=c/2-(h.r-this.range.r.mid)*r*2),o=[["M",[i(s,3),i(a,3)]]],"r"==this.properties.orientation?(o.push(["m",[r,-n]]),o.push(["l",[0,2*n,-r,n,-r,-n,0,-2*n,r,-n,r,n]]),o.push(["z",[]])):(o.push(["m",[-n,r]]),o.push(["l",[2*n,0,n,-r,-n,-r,-2*n,0,-n,r]]),o.push(["z",[]])),{array:o,path:function(t){for(var e="",i=0;i<t.length;i++)e+=(t[i][0]?t[i][0]:" ")+(t[i][1].length>0?t[i][1].join(","):" ");return e}(o),x:s,y:a}):this},this.updateLabels=function(t,e){var i,s,a,r;for(s in this.areas)this.mapping.hexes[s]&&(i=this.areas[s].labelprops,a="",a="string"==typeof t?t in this.mapping.hexes[s]?this.mapping.hexes[s][t]:"":this.mapping.hexes[s].n||this.mapping.hexes[s].msoa_name_hcl||"",this.areas[s].label.innerHTML=this.options.formatLabel(a,{x:i.x,y:i.y,hex:this.mapping.hexes[s],size:this.properties.size,"font-size":this.properties.s.sin}),r="",r="string"==typeof e?e in this.mapping.hexes[s]?this.mapping.hexes[s][e]:"":this.mapping.hexes[s].Tooltip||this.mapping.hexes[s].tooltip||this.mapping.hexes[s].n||this.mapping.hexes[s].msoa_name_hcl||"",this.areas[s].tooltip.innerHTML=this.options.formatTooltip(r,{x:i.x,y:i.y,hex:this.mapping.hexes[s],size:this.properties.size,"font-size":parseFloat(this.style.default["font-size"])}));return this},this.updateColours=function(t){var e;for(e in"function"!=typeof t&&(t=function(){var t=this.style.default.fill;return w.mapping.hexes[e].colour&&(t=w.mapping.hexes[e].colour),"string"==typeof l.colours&&(t=l.colours),t}),this.mapping.hexes)this.mapping.hexes[e]&&(this.areas[e].fillcolour=t.call(this,e),this.setHexStyle(e));return this},this.updateBoundaries=function(t){var e,i;for(i in"function"!=typeof t&&(t=function(){return{stroke:"black","stroke-width":1}}),this.mapping.boundaries)(e=t.call(this,i,this.mapping.boundaries[i])||{}).fill="none",this.lines[i]&&n(this.lines[i],e);return this},this.draw=function(){var e,s,r,p;this.updateRange();var d,c,m,x,b,q,w,k,z,S=this.range,L=function(t){t.data.region&&t.data.hexmap.regionFocus(t.data.region),M(t,"mouseover")},H=function(t){M(t,"mouseout")},T=function(t){t.data.region&&t.data.hexmap.regionFocus(t.data.region),M(t,"click")};if((this.options.showgrid||this.options.clip)&&!this.grid){for(this.grid=o("g"),n(this.grid,{class:"hex-grid-holder"}),s=S.q.min;s<=S.q.max;s++)for(e=S.r.min;e<=S.r.max;e++)r=this.drawHex(s,e),this.options.showgrid&&(n(p=o("path"),{d:r.path,class:"hex-grid","data-q":s||"0","data-r":e||"0",fill:this.style.grid.fill||"","fill-opacity":"number"==typeof this.style.grid["fill-opacity"]?this.style.grid["fill-opacity"]:.1,stroke:"string"==typeof this.style.grid.stroke?this.style.grid.stroke:"#aaa","stroke-opacity":"number"==typeof this.style.grid["stroke-opacity"]?this.style.grid["stroke-opacity"]:.2}),a(p,this.grid),h("mouseover",p,{type:"grid",hexmap:this,data:{r:e,q:s}},L),h("mouseout",p,{type:"grid",hexmap:this,me:d,data:{r:e,q:s}},H),h("click",p,{type:"grid",hexmap:this,me:d,data:{r:e,q:s}},T));a(this.grid,u)}if(d=this,a(c=o("defs"),u),t.getAttribute("id"),l.patterns&&(c.innerHTML+=l.patterns.join("")),this.mapping.hexes){for(e in a(y,u),a(f,y),this.mapping.hexes)this.mapping.hexes[e]&&(r=this.drawHex(this.mapping.hexes[e].q,this.mapping.hexes[e].r),v||(w=i(r.x,3),k=i(r.y,3),(q=o("g")).classList.add("hex"),this.mapping.hexes[e].class&&q.classList.add(this.mapping.hexes[e].class),n(q,{"data-id":e,role:"cell"}),f.appendChild(q),n(m=o("path"),{d:r.path,"transform-origin":w+"px "+k+"px"}),n(q,{"data-q":this.mapping.hexes[e].q,"data-r":this.mapping.hexes[e].r}),q.appendChild(m),this.areas[e]={hex:q,path:m,selected:!1,active:!0,data:this.mapping.hexes[e],orig:r},h("mouseover",q,{type:"hex",hexmap:this,region:e,data:this.mapping.hexes[e],pop:this.mapping.hexes[e].p},L),h("mouseout",q,{type:"hex",hexmap:this,region:e,me:this.areas[e]},H),h("click",q,{type:"hex",hexmap:this,region:e,me:this.areas[e],data:this.mapping.hexes[e]},T),this.options.showlabel&&this.style.default["font-size"]>=this.options.minFontSize&&(this.options.clip&&(this.areas[e].clipid=(t.getAttribute("id")||"hex")+"-clip-"+e,this.areas[e].clip=o("clipPath"),this.areas[e].clip.setAttribute("id",this.areas[e].clipid),n(b=o("path"),{d:r.path,"transform-origin":r.x+"px "+r.y+"px"}),a(b,this.areas[e].clip),a(this.areas[e].clip,c)),z=o("title"),m.appendChild(z),x=o("text"),q.appendChild(x),n(x,{x:w,y:k,"transform-origin":w+"px "+k+"px","dominant-baseline":"central","data-q":this.mapping.hexes[e].q,"data-r":this.mapping.hexes[e].r,class:"hex-label","text-anchor":"middle","font-size":this.properties.s.sin+"px",title:this.mapping.hexes[e].n||e,_region:e}),this.options.clip&&n(x,{"clip-path":"url(#"+this.areas[e].clipid+")"}),this.areas[e].label=x,this.areas[e].tooltip=z,this.areas[e].labelprops={x:w,y:k})),this.setHexStyle(e),n(this.areas[e].path,{stroke:this.style.default.stroke,"stroke-opacity":this.style.default["stroke-opacity"],"stroke-width":this.style.default["stroke-width"],title:this.mapping.hexes[e].n,"data-regions":e,style:"cursor: pointer;"}));this.updateLabels()}return this.drawBoundaries(),this.mapping.hexes&&a(g,u),v=!0,this},this.drawBoundaries=function(){if(this.mapping.boundaries){var t,e,s,r,h,l,p;for(t in m||(m=o("g")).classList.add("lines"),m.innerHTML="",this.lines={},r=this.mapping.boundaries){if(s="",h=null,r[t].edges)for(e=0;e<r[t].edges.length;e++)(l=this.getEdge(r[t].edges[e]))&&((p=h&&l[0]==h[4]&&l[1]==h[5]?"":"M")&&(s+=p+l[0]+" "+l[1]),0==l[2]?s+="v"+i(l[3],2):0==l[3]?s+="h"+i(l[2],2):s+="l"+i(l[2],2)+" "+i(l[3],2),h=l);s&&(this.lines[t]=o("path"),n(this.lines[t],{d:s,"data-name":t}),m.append(this.lines[t]))}a(m,u),this.updateBoundaries()}return this},this.size(),l.hexjson&&this.load(l.hexjson,l.ready),this};var s="http://www.w3.org/2000/svg";function a(t,e){return e.appendChild(t)}function r(t){return JSON.parse(JSON.stringify(t))}function n(t,e){for(var i in e)e[i]&&t.setAttribute(i,e[i]);return t}function o(t){return document.createElementNS(s,t)}function h(t,e,i,s){e&&(e.length||(e=[e]),"function"==typeof s&&e.forEach(function(e){e.addEventListener(t,function(t){t.data=i,s.call(i.this||this,t)})}))}t.OI=e}(window||this);