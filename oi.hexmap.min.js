/**
	OI hex map in SVG
	0.7.0:
	    - Draw boundary lines
	0.6.4:
		- Remove browser tooltip
	0.6.3:
		- fitToRange()
	0.6.2:
		- allow multiple callbacks to be added with .on()
	0.6.1:
		- bug fixes
	0.6.0:
		- change namespace
		- set padding
		- can provide function to updateColours()
 */
!function(t){var e=t.OI||{};function i(t,e){return"number"==typeof t&&(t=t.toFixed(e)),t.replace(/\.([0-9]+)0+$/,function(t,e){return"."+e}).replace(/\.0+$/,"")}e.ready||(e.ready=function(t){"loading"!=document.readyState?t():document.addEventListener("DOMContentLoaded",t)}),e.ajax||(e.ajax=function(t,e){e||(e={});var i=new XMLHttpRequest;return"responseType"in i&&e.dataType&&(i.responseType=e.dataType),i.open(e.method||"GET",t+(e.cache?"?"+Math.random():""),!0),i.onload=function(i){if(this.status>=200&&this.status<400){var s=this.response;"function"==typeof e.success&&e.success.call(e.this||this,s,{url:t,data:e,originalEvent:i})}else"function"==typeof e.error&&e.error.call(e.this||this,i,{url:t,data:e})},"function"==typeof e.error&&(i.onerror=function(i){e.error.call(e.this||this,i,{url:t,data:e})}),i.send(),this}),e.hexmap=function(t,l){this.version="0.7.0",l||(l={}),this._attr=l,this.title="OI HexMap",this.logging=location.search.indexOf("debug=true")>=0;var p=new function(t){return t||(t={}),t.title||(t.title="Log"),t.version||(t.version="2.0"),this.message=function(...e){var i=e.shift();"string"!=typeof i&&(i="log");var s=["%c"+t.title+" "+t.version+"%c"];e.length>0&&(s[0]+=":","string"==typeof e[0]&&(s[0]+=" "+e.shift())),s.push("font-weight:bold;"),s.push(""),e.length>0&&(s=s.concat(e)),console[i].apply(null,s)},this}({title:"OI HexMap",version:this.version});if(this.log=p.message,!t)return this.log("warn","No DOM element to add to"),this;l.label||(l.label={}),l.grid||(l.grid={}),"boolean"!=typeof l.label.show&&(l.label.show=!1),"boolean"!=typeof l.label.clip&&(l.label.clip=!1),"boolean"!=typeof l.grid.show&&(l.grid.show=!1);var d=l.width||t.offsetWidth||300,c=l.height||t.offsetHeight||150;this.maxw=d,this.maxh=c;var f,u,g,m,y=d/c,x=!1,v={},b=parseFloat(getComputedStyle(t)["font-size"])||16;for(var q in this.areas={},this.padding="number"==typeof l.padding?l.padding:0,this.properties={size:l.size},this.callback={},this.mapping={},t.querySelector(".hexmap-inner")||(this.el=document.createElement("div"),this.el.classList.add("hexmap-inner"),t.appendChild(this.el)),this.options={clip:l.label.clip,showgrid:l.grid.show,showlabel:l.label.show,formatLabel:"function"==typeof l.label.format?l.label.format:function(t,e){return t.substr(0,3)},minFontSize:"number"==typeof l.minFontSize?l.minFontSize:4},this.style={default:{fill:"#cccccc","fill-opacity":1,"font-size":b,"stroke-width":1.5,"stroke-opacity":1,stroke:"#ffffff"},highlight:{fill:"#1DD3A7"},grid:{fill:"#aaa","fill-opacity":.1}},l.style)l.style[q]&&(this.style[q]||(this.style[q]={}),l.style[q].fill&&(this.style[q].fill=l.style[q].fill),l.style[q]["fill-opacity"]&&(this.style[q]["fill-opacity"]=l.style[q]["fill-opacity"]),l.style[q]["font-size"]&&(this.style[q]["font-size"]=l.style[q]["font-size"]),l.style[q].stroke&&(this.style[q].stroke=l.style[q].stroke),l.style[q]["stroke-width"]&&(this.style[q]["stroke-width"]=l.style[q]["stroke-width"]),l.style[q]["stroke-opacity"]&&(this.style[q]["stroke-opacity"]=l.style[q]["stroke-opacity"]));this.setHexSize=function(t){return"number"!=typeof t&&(t=10),t=Math.round(100*t)/100,l.size=t,this.properties.size=t,this},this.load=function(t,i,s){function a(t,e){w.setMapping(t),e&&w.updateColours(),"function"==typeof s&&s.call(w,{data:i})}return"function"!=typeof i||s||(s=i,i=""),"string"==typeof t?e.ajax(t,{this:this,dataType:"json",success:function(t){a(t)},error:function(e,i){this.log("error","Unable to load "+t,i)}}):"object"==typeof t&&a(t,!0),this};var w=this;function z(t,e,i){return"odd-r"==i&&0!=(1&e)&&(t+=.5),"even-r"==i&&0==(1&e)&&(t+=.5),"odd-q"==i&&0!=(1&t)&&(e+=.5),"even-q"==i&&0==(1&t)&&(e+=.5),{q:t,r:e}}return window.addEventListener("resize",function(t){w.size()}),this.setHexStyle=function(t){var e,i,s,a;if(e=this.areas[t],i=r(this.style.default),s="",e.active&&(i.fill=e.fillcolour),e.hover&&(s+=" hover"),e.selected){for(a in this.style.selected)this.style.selected[a]&&(i[a]=this.style.selected[a]);s+=" selected"}return this.mapping.hexes[t].class&&(s+=" "+this.mapping.hexes[t].class),i.class="hex-cell"+s,n(e.hex,i),e.label&&n(e.label,{class:"hex-label"+s}),e},this.toFront=function(t){for(var e,i,s,r=m.childNodes,h=0;h<r.length;h++)a(r[h],u);if(this.areas[t]){for(var o in this.areas)this.areas[o]&&(this.areas[o].selected&&a(this.areas[o].g,m),this.options.clip&&(e=this.areas[o],s=void 0,i=getComputedStyle(e.hex),s={},i.transform&&(s.transform=i.transform),"none"==s.transform&&(s.transform=""),i["transform-origin"]&&(s["transform-origin"]=i["transform-origin"]),n(e.clip,s)));a(this.areas[t].g,m)}return this},this.regionToggleSelected=function(t,e){var i,s;if(this.selected=this.selected==t?"":t,(s=this.areas[t]).selected=!s.selected,this.setHexStyle(t),!s.selected&&e)for(i in this.areas)this.areas[i].selected&&(this.areas[i].selected=!1,this.setHexStyle(i));return this},this.regionFocus=function(t){return this.areas[t].hover=!0,this.el.querySelectorAll(".hover").forEach(function(t){t.classList.remove("hover")}),this.setHexStyle(t),this.toFront(t),this},this.regionBlur=function(t){return this.areas[t].hover=!1,this.setHexStyle(t),this},this.regionActivate=function(t){this.areas[t].active=!0,this.setHexStyle(t)},this.regionDeactivate=function(t){this.areas[t].active=!1,this.setHexStyle(t)},this.regionToggleActive=function(t){this.areas[t].active=!this.areas[t].active,this.setHexStyle(t)},this.selectRegion=function(t){for(var e in this.selected=t,this.areas)this.areas[e]&&(t.length>0&&0==e.indexOf(t)?(this.areas[e].selected=!0,this.setHexStyle(e)):(this.areas[e].selected=!1,this.setHexStyle(e)));return this},this.on=function(t,e,i){return"function"!=typeof e||i||(i=e,e=""),"function"!=typeof i?this:(this.callback||(this.callback={}),this.callback[t]||(this.callback[t]=[]),this.callback[t].push({fn:i,attr:e}),this)},this.size=function(e,i){this.el.style.height="",this.el.style.width="",n(t,{style:""}),f&&n(f,{width:0,height:0}),e=Math.min(this.maxw,t.offsetWidth),this.el.style.height=e/y+"px",this.el.style.width=e+"px",i=Math.min(this.maxh,this.el.offsetHeight),f||(n(f=h("svg"),{class:"hexmap-map",xmlns:s,version:"1.1",overflow:"visible",viewBox:l.viewBox||"0 0 "+e+" "+i,style:"max-width:100%;",preserveAspectRatio:"xMinYMin meet","vector-effect":"non-scaling-stroke"}),a(f,this.el),(u=h("g")).classList.add("data-layer"),u.setAttribute("role","list"),(g=h("g")).classList.add("lines"),(m=h("g")).classList.add("overlay")),n(f,{width:e,height:i});var r=e/d;return this.properties.size=l.size*r,d=e,c=i,this.el.style.height="",this.el.style.width="",this},this.initialized=function(){this.create().draw();var e=t.querySelector(".spinner");return e&&e.parentNode.removeChild(e),this},this.create=function(){return f.innerHTML="",this.areas={},this.grid&&this.grid.remove(),delete this.grid,x=!1,this},this.setMapping=function(t){this.mapping=t,this.properties||(this.properties={x:100,y:100});var e=t.layout.split("-");return this.properties.shift=e[0],this.properties.orientation=e[1],this.updateRange(),this.initialized()},this.updateRange=function(){var t,e,i,s;for(t in v={r:{min:1/0,max:-1/0},q:{min:1/0,max:-1/0}},this.mapping.hexes)this.mapping.hexes[t]&&(i=(e=this.mapping.hexes[t]).q,s=e.r,"odd-r"==this.mapping.layout&&!0&e.r&&(i+=.5),"even-r"==this.mapping.layout&&!1&e.r&&(i+=.5),"odd-q"==this.mapping.layout&&!0&e.q&&(s+=.5),"even-q"==this.mapping.layout&&!1&e.q&&(s+=.5),i>v.q.max&&(v.q.max=i),i<v.q.min&&(v.q.min=i),s>v.r.max&&(v.r.max=s),s<v.r.min&&(v.r.min=s));return v.q.min-=this.padding,v.q.max+=this.padding,v.r.min-=this.padding,v.r.max+=this.padding,v.q.min=Math.floor(v.q.min),v.q.max=Math.ceil(v.q.max),v.r.min=Math.floor(v.r.min),v.r.max=Math.ceil(v.r.max),v.q.d=v.q.max-v.q.min,v.r.d=v.r.max-v.r.min,v.q.mid=v.q.min+v.q.d/2,v.r.mid=v.r.min+v.r.d/2,this.range=r(v),"number"!=typeof l.size&&this.setHexSize(this.estimateSize()),this.setSize(),this},this.fitToRange=function(){return this.updateRange(),this.setHexSize(this.estimateSize()),this.setSize(),this},this.estimateSize=function(){return"r"==this.properties.orientation?Math.min(.5*c/(.75*v.r.d+1),1/Math.sqrt(3)*d/(v.q.d+1)):Math.min(1/Math.sqrt(3)*c/(v.r.d+1),.5*d/(.75*v.q.d+1))},this.setSize=function(t){return t&&(this.properties.size=t),this.properties.s={cos:Math.round(10*this.properties.size*Math.sqrt(3)/2)/10,sin:.5*this.properties.size},this.properties.s.c=this.properties.s.cos.toFixed(2),this.properties.s.s=this.properties.s.sin.toFixed(2),this},this.getEdge=function(t){var e,s,a,r,n,h,o;return this.properties&&(a=this.properties.s.cos,r=this.properties.s.sin,o=Math.abs(t.e),h=t.e>=0,"number"==typeof t.q&&"number"==typeof t.r&&"number"==typeof o&&o>=1&&o<=6)?(n=z(t.q,t.r,this.mapping.layout),"r"==this.properties.orientation?(e=d/2+(n.q-this.range.q.mid)*a*2,s=c/2-(n.r-this.range.r.mid)*r*3):(e=d/2+(n.q-this.range.q.mid)*r*3,s=c/2-(n.r-this.range.r.mid)*a*2),(o=("r"==this.properties.orientation?[[e,s-2*r,a,r],[e+a,s-r,0,2*r],[e+a,s+r,-a,r],[e,s+2*r,-a,-r],[e-a,s+r,0,-2*r],[e-a,s-r,a,-r]]:[[e-r,s-a,2*r,0],[e+r,s-a,r,a],[e+2*r,s,-r,a],[e+r,s+a,-2*r,0],[e-r,s+a,-r,-a],[e-2*r,s,r,-a]])[o-1])[4]=o[0]+o[2],o[5]=o[1]+o[3],h||(o=[o[4],o[5],-o[2],-o[3],o[0],o[1]]),o[0]=i(o[0],3),o[1]=i(o[1],3),o[4]=i(o[4],3),o[5]=i(o[5],3),o):null},this.drawHex=function(t,e){var i,s,a,r,n,h;return this.properties?(a=this.properties.s.cos,r=this.properties.s.sin,h=z(t,e,this.mapping.layout),"r"==this.properties.orientation?(i=d/2+(h.q-this.range.q.mid)*a*2,s=c/2-(h.r-this.range.r.mid)*r*3):(i=d/2+(h.q-this.range.q.mid)*r*3,s=c/2-(h.r-this.range.r.mid)*a*2),n=[["M",[i=parseFloat(i.toFixed(1)),s]]],"r"==this.properties.orientation?(n.push(["m",[a,-r]]),n.push(["l",[0,2*r,-a,r,-a,-r,0,-2*r,a,-r,a,r]]),n.push(["z",[]])):(n.push(["m",[-r,a]]),n.push(["l",[2*r,0,r,-a,-r,-a,-2*r,0,-r,a]]),n.push(["z",[]])),{array:n,path:function(t){for(var e="",i=0;i<t.length;i++)e+=(t[i][0]?t[i][0]:" ")+(t[i][1].length>0?t[i][1].join(","):" ");return e}(n),x:i,y:s}):this},this.updateColours=function(t){var e;for(e in"function"!=typeof t&&(t=function(){var t=this.style.default.fill;return w.mapping.hexes[e].colour&&(t=w.mapping.hexes[e].colour),"string"==typeof l.colours&&(t=l.colours),t}),this.mapping.hexes)this.mapping.hexes[e]&&(this.areas[e].fillcolour=t.call(this,e),this.setHexStyle(e));return this},this.updateBoundaries=function(t){var e,i;for(i in"function"!=typeof t&&(t=function(){return{}}),this.mapping.boundaries)(e=t.call(this,i,this.mapping.boundaries[i])||{}).fill="none",this.lines[i]&&n(this.lines[i],e)},this.draw=function(){var e,s,r,l;this.updateRange();var p=this.range;function d(t,e){var i=[];if(t.data.hexmap.callback[e])for(var s=0;s<t.data.hexmap.callback[e].length;s++){for(var a in t.data.hexmap.callback[e][s].attr)t.data.hexmap.callback[e][s].attr[a]&&(t.data[a]=t.data.hexmap.callback[e][s].attr[a]);"function"==typeof t.data.hexmap.callback[e][s].fn&&i.push(t.data.hexmap.callback[e][s].fn.call(t.data.this||this,t))}return i||!1}var c,y,v,b,q,w,z=function(t){t.data.region&&t.data.hexmap.regionFocus(t.data.region),d(t,"mouseover")},k=function(t){d(t,"mouseout")},S=function(t){t.data.region&&t.data.hexmap.regionFocus(t.data.region),d(t,"click")};if((this.options.showgrid||this.options.clip)&&!this.grid){for(this.grid=h("g"),n(this.grid,{class:"hex-grid-holder"}),s=p.q.min;s<=p.q.max;s++)for(e=p.r.min;e<=p.r.max;e++)r=this.drawHex(s,e),this.options.showgrid&&(n(l=h("path"),{d:r.path,class:"hex-grid","data-q":s||"0","data-r":e||"0",fill:this.style.grid.fill||"","fill-opacity":this.style.grid["fill-opacity"]||.1,stroke:this.style.grid.stroke||"#aaa","stroke-opacity":this.style.grid["stroke-opacity"]||.2}),a(l,this.grid),o("mouseover",l,{type:"grid",hexmap:this,data:{r:e,q:s}},z),o("mouseout",l,{type:"grid",hexmap:this,me:c,data:{r:e,q:s}},k),o("click",l,{type:"grid",hexmap:this,me:c,data:{r:e,q:s}},S));a(this.grid,f)}if(c=this,a(y=h("defs"),f),t.getAttribute("id"),this.mapping.hexes)for(e in a(u,f),this.mapping.hexes)this.mapping.hexes[e]&&(r=this.drawHex(this.mapping.hexes[e].q,this.mapping.hexes[e].r),x||(n(w=h("g"),{data:e,role:"listitem"}),u.appendChild(w),n(v=h("path"),{d:r.path,class:"hex-cell hex","transform-origin":r.x+"px "+r.y+"px","data-q":this.mapping.hexes[e].q,"data-r":this.mapping.hexes[e].r}),w.appendChild(v),this.areas[e]={g:w,hex:v,selected:!1,active:!0,data:this.mapping.hexes[e],orig:r},o("mouseover",w,{type:"hex",hexmap:this,region:e,data:this.mapping.hexes[e],pop:this.mapping.hexes[e].p},z),o("mouseout",w,{type:"hex",hexmap:this,region:e,me:this.areas[e]},k),o("click",w,{type:"hex",hexmap:this,region:e,me:this.areas[e],data:this.mapping.hexes[e]},S),this.options.showlabel&&this.style.default["font-size"]>=this.options.minFontSize&&(this.options.clip&&(this.areas[e].clipid=(t.getAttribute("id")||"hex")+"-clip-"+e,this.areas[e].clip=h("clipPath"),this.areas[e].clip.setAttribute("id",this.areas[e].clipid),n(q=h("path"),{d:r.path,"transform-origin":r.x+"px "+r.y+"px"}),a(q,this.areas[e].clip),a(this.areas[e].clip,y)),b=h("text"),w.appendChild(b),b.innerHTML=this.options.formatLabel(this.mapping.hexes[e].n||this.mapping.hexes[e].msoa_name_hcl,{x:r.x,y:r.y,hex:this.mapping.hexes[e],size:this.properties.size,"font-size":parseFloat(getComputedStyle(b)["font-size"])}),n(b,{x:r.x,y:r.y,"transform-origin":r.x+"px "+r.y+"px","dominant-baseline":"central","clip-path":"url(#"+this.areas[e].clipid+")","data-q":this.mapping.hexes[e].q,"data-r":this.mapping.hexes[e].r,class:"hex-label","text-anchor":"middle","font-size":this.style.default["font-size"]+"px",title:this.mapping.hexes[e].n||e,_region:e}),this.areas[e].label=b,this.areas[e].labelprops={x:r.x,y:r.y})),this.setHexStyle(e),n(this.areas[e].hex,{stroke:this.style.default.stroke,"stroke-opacity":this.style.default["stroke-opacity"],"stroke-width":this.style.default["stroke-width"],title:this.mapping.hexes[e].n,"data-regions":e,style:"cursor: pointer;"}));if(this.mapping.boundaries){var M,H,F,L,C,E;for(M in a(g,f),this.lines={},L=this.mapping.boundaries){if(F="",C=null,L[M].edges)for(H=0;H<L[M].edges.length;H++)(E=this.getEdge(L[M].edges[H]))&&(F+=(C&&E[0]==C[4]&&E[1]==C[5]?"L":"M")+i(E[0],2)+" "+i(E[1],2)+"l"+i(E[2],2)+" "+i(E[3],2),C=E);F&&(this.lines[M]=h("path"),n(this.lines[M],{d:F,"data-name":M}),g.append(this.lines[M]))}this.updateBoundaries()}return this.mapping.hexes&&a(m,f),x=!0,this},this.size(),l.hexjson&&this.load(l.hexjson,l.ready),this};var s="http://www.w3.org/2000/svg";function a(t,e){return e.appendChild(t)}function r(t){return JSON.parse(JSON.stringify(t))}function n(t,e){for(var i in e)e[i]&&t.setAttribute(i,e[i]);return t}function h(t){return document.createElementNS(s,t)}function o(t,e,i,s){e&&(e.length||(e=[e]),"function"==typeof s&&e.forEach(function(e){e.addEventListener(t,function(t){t.data=i,s.call(i.this||this,t)})}))}t.OI=e}(window||this);